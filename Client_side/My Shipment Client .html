<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Shipments - Courier Tracking System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="Client Dashboard.html">
      <i class="fas fa-box me-2"></i> CourierExpress
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="Client Dashboard.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="My Shipment Client .html">My Shipments</a></li>
        <li class="nav-item"><a class="nav-link" href="New Shipment Client.html">New Shipment</a></li>
        <li class="nav-item"><a class="nav-link" href="Tracking page Client.html">Track</a></li>
        <li class="nav-item"><a class="nav-link" href="Client History.html">History</a></li>
        <li class="nav-item"><a class="nav-link" href="#" id="logout-link" onclick="logout(); return false;">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

  <div class="card">
    <div class="card-body table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Tracking ID</th>
            <th>From</th>
            <th>To</th>
            <th>Status</th>
            <th>Progress</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="shipments-tbody">
          <!-- rows are rendered by client-side JS -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- View Shipment Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Shipment Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="viewModalBody">
        <!-- populated by JS -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Track Shipment Modal -->
<div class="modal fade" id="trackModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tracking History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="trackModalBody">
        <!-- populated by JS -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Sample shipments data used as fallback if no API is available.
  const sampleShipments = [
    {
      id: 'CX123456789', from: 'Delhi, DL', to: 'Mumbai, MH', status: 'Delivered', progress: 100,
      weight: '2kg', service: 'Express', createdAt: '2025-10-28', history: [
        {time: '2025-10-28 09:00', status: 'Picked up', location: 'Delhi'},
        {time: '2025-10-29 14:00', status: 'In Transit', location: 'Jaipur'},
        {time: '2025-10-30 11:00', status: 'Delivered', location: 'Mumbai'}
      ]
    },
    {
      id: 'CX987654321', from: 'Bangalore, KA', to: 'Chennai, TN', status: 'In Transit', progress: 65,
      weight: '5kg', service: 'Standard', createdAt: '2025-11-02', history: [
        {time: '2025-11-02 10:30', status: 'Picked up', location: 'Bangalore'},
        {time: '2025-11-03 18:00', status: 'Arrived at sorting', location: 'Bangalore'},
        {time: '2025-11-04 09:00', status: 'In Transit', location: 'Vellore'}
      ]
    },
    {
      id: 'CX456789123', from: 'Kolkata, WB', to: 'Pune, MH', status: 'Processing', progress: 25,
      weight: '1kg', service: 'Economy', createdAt: '2025-11-05', history: [
        {time: '2025-11-05 08:00', status: 'Order Received', location: 'Kolkata'}
      ]
    }
  ];

  // Try to fetch shipments from /api/shipments; fallback to sampleShipments
  async function fetchShipments() {
    try {
      const res = await fetch('/api/shipments');
      if (!res.ok) throw new Error('API error');
      return await res.json();
    } catch (e) {
      console.warn('Using fallback sample shipments:', e.message);
      return sampleShipments;
    }
  }

  async function fetchShipmentById(id) {
    try {
      const res = await fetch('/api/shipments/' + encodeURIComponent(id));
      if (!res.ok) throw new Error('API error');
      return await res.json();
    } catch (e) {
      // find locally
      return sampleShipments.find(s => s.id === id) || null;
    }
  }

  function badgeForStatus(status) {
    const map = { 'Delivered': 'success', 'In Transit': 'warning', 'Processing': 'primary' };
    return map[status] || 'secondary';
  }

  function renderShipmentsList(shipments) {
    const tbody = document.getElementById('shipments-tbody');
    tbody.innerHTML = '';
    shipments.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.id}</td>
        <td>${s.from}</td>
        <td>${s.to}</td>
        <td><span class="badge bg-${badgeForStatus(s.status)}">${s.status}</span></td>
        <td><div class="progress"><div class="progress-bar" style="width:${s.progress}%"></div></div></td>
        <td>
          <button class="btn btn-sm btn-outline-primary me-1" data-action="view" data-id="${s.id}">View</button>
          <button class="btn btn-sm btn-outline-secondary" data-action="track" data-id="${s.id}">Track</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function populateViewModal(shipment) {
    const container = document.getElementById('viewModalBody');
    if (!shipment) { container.innerHTML = '<p class="text-muted">Shipment not found.</p>'; return; }
    container.innerHTML = `
      <dl class="row">
        <dt class="col-sm-3">Tracking ID</dt><dd class="col-sm-9">${shipment.id}</dd>
        <dt class="col-sm-3">From</dt><dd class="col-sm-9">${shipment.from}</dd>
        <dt class="col-sm-3">To</dt><dd class="col-sm-9">${shipment.to}</dd>
        <dt class="col-sm-3">Status</dt><dd class="col-sm-9">${shipment.status}</dd>
        <dt class="col-sm-3">Progress</dt><dd class="col-sm-9"><div class="progress"><div class="progress-bar" style="width:${shipment.progress}%"></div></div></dd>
        <dt class="col-sm-3">Service</dt><dd class="col-sm-9">${shipment.service || '—'}</dd>
        <dt class="col-sm-3">Weight</dt><dd class="col-sm-9">${shipment.weight || '—'}</dd>
        <dt class="col-sm-3">Created</dt><dd class="col-sm-9">${shipment.createdAt || '—'}</dd>
      </dl>
    `;
  }

  function populateTrackModal(shipment) {
    const container = document.getElementById('trackModalBody');
    if (!shipment) { container.innerHTML = '<p class="text-muted">Shipment not found.</p>'; return; }
    const history = shipment.history || [];
    const rows = history.map(h => `
      <li class="list-group-item">
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1">${h.status}</h6>
          <small>${h.time}</small>
        </div>
        <p class="mb-1 text-muted">${h.location || ''}</p>
      </li>
    `).join('');
    container.innerHTML = `
      <h6>Tracking for <strong>${shipment.id}</strong></h6>
      <div class="my-2"><div class="progress"><div class="progress-bar" style="width:${shipment.progress}%"></div></div></div>
      <ul class="list-group">${rows || '<li class="list-group-item text-muted">No history available</li>'}</ul>
    `;
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const shipments = await fetchShipments();
    renderShipmentsList(shipments);

    document.getElementById('shipments-tbody').addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      if (action === 'view') {
        const s = await fetchShipmentById(id);
        populateViewModal(s);
        const modal = new bootstrap.Modal(document.getElementById('viewModal'));
        modal.show();
      } else if (action === 'track') {
        const s = await fetchShipmentById(id);
        populateTrackModal(s);
        const modal = new bootstrap.Modal(document.getElementById('trackModal'));
        modal.show();
      }
    });
  });
</script>
<script>
  // mark active nav link based on current filename
  document.addEventListener('DOMContentLoaded', function() {
    const current = location.pathname.split('/').pop();
    document.querySelectorAll('.navbar .nav-link').forEach(a => {
      if (a.getAttribute('href') === current) {
        a.classList.add('active');
        a.setAttribute('aria-current','page');
      }
    });
  });
</script>
<script src="js/logout.js"></script>
</body>
</html>
